main:

  params: [input]

 

  steps:

    - init:

        assign:

          - project_id: sandbox-dev-478813

          - image_id: ${default(map.get(input, "image_id"), "test-rhel-vm-image")}

          - validation_bucket: "validation-scripts-sandbox-dev-478813"

          - display_project_id: ${default(map.get(input, "display_project_id"), "spoke-project1-476804")}

 

    # Step 1: Create VM and run validation

    - validation:

        call: validate_image

        args:

          image_id: ${image_id}

          project_id: ${project_id}

          validation_bucket: ${validation_bucket}

        result: validation_results

 

    # Step 2: Check if validation passed

    - check_result:

        switch:

          - condition: ${validation_results.scan_result != "Pass"}

            next: cleanup

 

    # Step 3: Promote image (only if Pass)

    - promotion:

        call: promote_image

        args:

          image_id: ${image_id}

          project_id: ${project_id}

          display_project_id: ${display_project_id}

        result: promotion_result

        next: cleanup

 

    # Step 4: Cleanup VM

    - cleanup:

        call: cleanup_vm

        args:

          instance_name: ${validation_results.validation_instance}

          project_id: ${project_id}

        result: cleanup_result

 

    # Step 5: Return final result

    - return_result:

        return:

          image_id: ${image_id}

          validation_result: ${validation_results.scan_result}

          validation_instance: ${validation_results.validation_instance}

          promotion_result: ${default(promotion_result, "skipped")}

          cleanup_result: ${cleanup_result}

 

# -------------------------------------------------------------------

#   VALIDATION: Create VM, run scripts, read result from GCS bucket

# -------------------------------------------------------------------

 

validate_image:

  params: [image_id, project_id, validation_bucket]

 

  steps:

    - create_and_validate:

        call: googleapis.cloudbuild.v1.projects.builds.create

        args:

          projectId: ${project_id}

          parent: ${"projects/" + project_id + "/locations/global"}

          body:

            steps:

              - name: "gcr.io/cloud-builders/gcloud"

                entrypoint: "bash"

                args:

                  - -c

                  - |

                    set -e

                    INSTANCE_NAME="${_IMAGE_ID}-validation"

                    echo "Step 1: Creating validation VM: $${INSTANCE_NAME}"

                    gcloud compute instances create "$${INSTANCE_NAME}" --image=projects/sandbox-dev-478813/global/images/${_IMAGE_ID} --machine-type=n1-standard-1 --subnet=default --service-account=sa-kitchen-sh@sandbox-dev-478813.iam.gserviceaccount.com --zone=us-central1-a --project=sandbox-dev-478813 --scopes=cloud-platform,https://www.googleapis.com/auth/cloud-platform --metadata=enable-oslogin=TRUE

                    echo "VM created. Waiting for VM to be ready..."

                    sleep 60

                    echo "Step 2: Downloading validation scripts from GCS to VM..."

                    gcloud compute ssh "$${INSTANCE_NAME}" --zone=us-central1-a --project=sandbox-dev-478813 --command="mkdir -p ~/validation && gsutil -m cp -r gs://${_VALIDATION_BUCKET}/validation/* ~/validation/ && chmod +x ~/validation/*.sh" 2>&1

                    echo "Step 3: Running validation script on VM..."

                    gcloud compute ssh "$${INSTANCE_NAME}" --zone=us-central1-a --project=sandbox-dev-478813 --command="cd ~/validation && bash validate_all.sh" 2>&1

                    VALIDATION_EXIT_CODE=$?

                    echo "Validation script exit code: $${VALIDATION_EXIT_CODE}"

                    # Determine validation result

                    if [ $${VALIDATION_EXIT_CODE} -eq 0 ]; then

                      VALIDATION_RESULT="Pass"

                      echo "VALIDATION: PASS"

                    else

                      VALIDATION_RESULT="Fail"

                      echo "VALIDATION: FAIL (exit code: $${VALIDATION_EXIT_CODE})"

                    fi

                    echo "Step 4: Writing validation result to GCS bucket..."

                    RESULT_FILE="gs://${_VALIDATION_BUCKET}/validation-results/$${INSTANCE_NAME}-result.json"

                    # Create result JSON

                    echo "{\"instance_name\":\"$${INSTANCE_NAME}\",\"validation_result\":\"$${VALIDATION_RESULT}\",\"validation_exit_code\":$${VALIDATION_EXIT_CODE},\"timestamp\":\"$$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > /tmp/validation_result.json

                    # Upload to GCS

                    gsutil cp /tmp/validation_result.json "$${RESULT_FILE}" 2>&1

                    echo "Validation result written to: $${RESULT_FILE}"

                    echo "Final validation result: $${VALIDATION_RESULT}"

                    echo "{\"instance_name\":\"$${INSTANCE_NAME}\",\"scan_result\":\"$${VALIDATION_RESULT}\"}" > "$$BUILDER_OUTPUT/output"

            substitutions:

              _IMAGE_ID: ${image_id}

              _VALIDATION_BUCKET: ${validation_bucket}

            options:

              dynamic_substitutions: true

            tags:

              - "validation"

        result: build_result

 

    - decode_result:

        assign:

          - result_json: ${text.decode(base64.decode(build_result.metadata.build.results.buildStepOutputs[0]))}

          - result: ${json.decode(result_json)}

          - instance_name: ${result.instance_name}

          - scan_result: ${result.scan_result}

 

    - return_validation_result:

        return:

          validation_instance: ${instance_name}

          scan_result: ${scan_result}

 

# -------------------------------------------------------------------

#   PROMOTE IMAGE: Copy image to display project

# -------------------------------------------------------------------

 

promote_image:

  params: [image_id, project_id, display_project_id]

 

  steps:

    - promote:

        call: googleapis.cloudbuild.v1.projects.builds.create

        args:

          projectId: ${project_id}

          parent: ${"projects/" + project_id + "/locations/global"}

          body:

            steps:

              - name: "gcr.io/cloud-builders/gcloud"

                entrypoint: "bash"

                args:

                  - -c

                  - |

                    set -e

                    SOURCE_IMAGE="${_IMAGE_ID}"

                    SOURCE_PROJECT="${_SOURCE_PROJECT_ID}"

                    DISPLAY_PROJECT="${_DISPLAY_PROJECT_ID}"

                    echo "Promoting image $${SOURCE_IMAGE} from $${SOURCE_PROJECT} to $${DISPLAY_PROJECT}..."

                    # Copy image to display project

                    PROMOTED_DATE=$$(date +%Y%m%d)
                    gcloud compute images create "$${SOURCE_IMAGE}" --source-image="projects/$${SOURCE_PROJECT}/global/images/$${SOURCE_IMAGE}" --project=$${DISPLAY_PROJECT} --description="Promoted validated image from $${SOURCE_PROJECT}" --family="rhel9-runtime" --labels=source_image="$${SOURCE_IMAGE}",source_project="$${SOURCE_PROJECT}",validation_status="passed",promoted_date="$${PROMOTED_DATE}"

                    echo "Waiting for image to be ready..."

                    # Wait for image to be ready

                    while true; do

                      STATUS=$$(gcloud compute images describe "$${SOURCE_IMAGE}" --project=$${DISPLAY_PROJECT} --format="get(status)" 2>/dev/null || echo "NOT_FOUND")

                      if [ "$${STATUS}" == "READY" ]; then

                        break

                      fi

                      sleep 10

                    done

                    echo "Image successfully promoted to $${DISPLAY_PROJECT}!"

                    echo "{\"promoted_image\":\"$${SOURCE_IMAGE}\",\"display_project\":\"$${DISPLAY_PROJECT}\"}" > "$$BUILDER_OUTPUT/output"

            substitutions:

              _IMAGE_ID: ${image_id}

              _SOURCE_PROJECT_ID: ${project_id}

              _DISPLAY_PROJECT_ID: ${display_project_id}

            options:

              dynamic_substitutions: true

            tags:

              - "promotion"

        result: promote_result

 

    - return_promote_result:

        return: ${"Image promoted successfully"}

 

# -------------------------------------------------------------------

#   CLEANUP: Delete validation VM

# -------------------------------------------------------------------

 

cleanup_vm:

  params: [instance_name, project_id]

 

  steps:

    - delete_vm:

        call: googleapis.cloudbuild.v1.projects.builds.create

        args:

          projectId: ${project_id}

          parent: ${"projects/" + project_id + "/locations/global"}

          body:

            steps:

              - name: "gcr.io/cloud-builders/gcloud"

                entrypoint: "bash"

                args:

                  - -c

                  - |

                    set -e

                    INSTANCE_NAME="${_INSTANCE_NAME}"

                    echo "Stopping VM $${INSTANCE_NAME}..."

                    gcloud compute instances stop "$${INSTANCE_NAME}" --zone=us-central1-a --project=sandbox-dev-478813 --quiet || echo "VM may already be stopped"

                    sleep 10

                    echo "Deleting VM $${INSTANCE_NAME}..."

                    gcloud compute instances delete "$${INSTANCE_NAME}" --zone=us-central1-a --project=sandbox-dev-478813 --quiet

                    echo "VM deleted successfully"

                    echo "{\"instance_deleted\":\"$${INSTANCE_NAME}\"}" > "$$BUILDER_OUTPUT/output"

            substitutions:

              _INSTANCE_NAME: ${instance_name}

            options:

              dynamic_substitutions: true

            tags:

              - "cleanup"

        result: cleanup_result

 

    - return_cleanup_result:

        return: ${"VM cleanup completed"}
